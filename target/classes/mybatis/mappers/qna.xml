<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.qna">
	<resultMap type="qnaDTO" id="qna">
		<result property="qna_id" column="qna_id"/>
		<result property="qna_parentId" column="qna_parentId"/>
		<result property="qna_writeId" column="qna_writeId"/>
		<result property="qna_title" column="qna_title"/>
		<result property="qna_content" column="qna_content"/>
		<result property="qna_regDate" column="qna_regDate"/>
		<result property="qna_status" column="qna_status"/>
		<result property="product_code" column="product_code"/>
		<result property="product_name" column="product_name"/>
	</resultMap>
	
	<resultMap type="qnaFileDTO" id="file">
		<result property="qna_fileId" column="qna_fileId"/>
		<result property="qna_id" column="qna_id"/>
		<result property="qna_fileName" column="qna_fileName"/>
	</resultMap>
	
	<!-- 
	<resultMap type="qna_list" id="qna_list">
		<result property="current_page" column="current_page"/>
		<result property="list_count" column="list_count"/>
		<result property="list_day" column="list_day"/>
		<result property="startDate" column="startDate"/>
		<result property="endDate" column="endDate"/>
		<result property="status" column="status"/>
		<result property="keyword_set" column="keyword_set"/>
		<result property="keyword" column="keyword"/>
	</resultMap>
	 -->
	
	<!-- 관리자 페이지 문의글 전체 -->
	<select id="all_qna" resultMap="qna" parameterType="java.util.Map">
		<![CDATA[
			select * from 
    		(select rownum rn, qna_id,product_name,qna_writeid,qna_title,qna_content,qna_regdate,qna_status,p.product_code from qna q,product p 
    		where q.product_code = p.product_code) where rn between (#{section}-1)*50 + (#{pageNum}-1)*5+1 and (#{section}-1)*50 + #{pageNum}*5
		]]>
	</select>
	
	<select id="total_qna" resultType="int">
		<![CDATA[
			select count(qna_id) from qna
		]]>
	</select>
	
	<!-- 검색결과 -->
	<select id="search_qna" resultMap="qna" parameterType="String">
		<![CDATA[
			select qna_id,product_name,qna_writeId,qna_title,qna_content,qna_regdate,qna_status,product_code from 
    		(select rownum rn, qna_id,product_name,qna_writeId,qna_title,qna_content,qna_regdate,qna_status,p.product_code from qna q,product p 
    		where q.product_code = p.product_code and qna_title like '%'||#{keyword}||'%' order by qna_regDate desc)
		]]>
	</select>
	
	<!-- 상품 상세페이지 내 문의글 -->
	<select id="product_qna" resultMap="qna" parameterType="java.util.Map">
		<![CDATA[
			select qna_id,product_name,qna_writeId,qna_title,qna_content,qna_regDate,qna_status,product_code from 
    		(select rownum rn, qna_id,product_name,qna_writeId,qna_title,qna_content,qna_regDate,qna_status,p.product_code from qna q,product p 
    		where q.product_code = #{product_code} and q.product_code = p.product_code order by qna_id desc) 
    		where rn between (#{section}-1)*50 + (#{pageNum}-1)*5+1 and (#{section}-1)*50 + #{pageNum}*5
		]]>
	</select>
	
	<select id="total_product_qna" resultType="int" parameterType="String">
		<![CDATA[
			select count(qna_id) from qna where product_code=#{product_code}
		]]>
	</select>
	
	<!-- 마이페이지 내 문의글 -->
	<select id="my_qna" resultMap="qna" parameterType="java.util.Map">
		<![CDATA[
			select * from 
    		(select rownum rn, qna_id,product_name,qna_writeid,qna_title,qna_content,qna_regdate,qna_status,p.product_code from qna q,product p 
    		where qna_writeId=#{qna_writeId} and q.product_code = p.product_code) where rn between (#{section}-1)*50 + (#{pageNum}-1)*5+1 and (#{section}-1)*50 + #{pageNum}*5
		]]>
	</select>
	
	<select id="my_qna_reply" resultMap="qna" parameterType="java.util.Map">
		<![CDATA[
			select qna_Id, qna_parentId, qna_content, qna_regDate from (select * from qna where qna_writeId = #{qna_writeId}) where qna_parentId = 1
		]]>
	</select>
	
	<select id="total_my_qna" resultType="int" parameterType="String">
		<![CDATA[
			select count(qna_id) from qna where qna_writeId=#{qna_writeId}
		]]>
	</select>
	
	<!-- 문의글 상세페이지 -->
	<select id="one_qna" resultMap="qna" parameterType="int">
		<![CDATA[
			select qna_id,product_name,qna_writeid,qna_title,qna_content,qna_regdate,qna_status,p.product_code from qna q,product p where qna_id = #{qna_id} and q.product_code = p.product_code
		]]>
	</select>
	
	<select id="one_qna_file" resultMap="file" parameterType="int">
		<![CDATA[
			select * from qna_file where qna_id = #{qna_id} and qna_fileName is not null
		]]>
	</select>
	
	<!-- 문의글 추가하기 -->
	<select id="new_qna_number" resultType="int">
		<![CDATA[
			select nvl(max(qna_id),0) from qna
		]]>
	</select>
	
	<select id="new_qna_file_number" resultType="int">
		<![CDATA[
			select nvl(max(qna_fileId),0) from qna_file
		]]>
	</select>
	
	<insert id="insert_qna" parameterType="java.util.Map">
		<![CDATA[
			insert into qna values(#{qna_id},0,#{qna_writeId},#{qna_title},#{qna_content},sysdate,0,#{product_code}) 
		]]>
	</insert>
	
	<insert id="insert_qna_file" parameterType="java.util.Map">
		<foreach collection="list" item="item" open="insert all" separator=" " close="select * from dual">
			into qna_file values(#{item.qna_fileId},#{item.qna_id},#{item.qna_fileName})
		</foreach>
	</insert>
	
	<!-- 문의글 수정 -->
	<update id="update_qna" parameterType="qnaDTO">
		<![CDATA[
			update qna set qna_title=#{qna_title},qna_content=#{qna_content} where qna_id=#{qna_id}
		]]>
	</update>
	
	<!-- 문의글 삭제 -->
	<delete id="delete_qna" parameterType="int">
		<![CDATA[
			delete from qna where qna_id=#{qna_id}
		]]>
	</delete>
	<delete id="delete_qna_file" parameterType="int">
		<![CDATA[
			delete from qna_file where qna_id=#{qna_id}
		]]>
	</delete>
	
	<!-- 문의글 답변 -->
	<insert id="insert_reply" parameterType="java.util.Map">
		<![CDATA[
			insert into qna values(#{qna_id},#{qna_parentId},'관리자',#{qna_title},#{qna_content},sysdate,1,#{product_code})
		]]>
	</insert>
	
	<update id="update_parentId" parameterType="int">
		<![CDATA[
			update qna set qna_status=1 where qna_id=#{qna_id}
		]]>
	</update>
	
	<select id="all_all_qna" resultMap="qna" parameterType="java.util.Map">
		<![CDATA[
			select rn,qna_id, product_name, qna_title, qna_content, qna_writeId, qna_regDate, qna_status, product_code from 
		    	(select rownum rn, qna_id, product_name, qna_title, qna_content, qna_writeId, qna_regDate, qna_status, q.product_code from qna q, product p
		    	where q.product_code = p.product_code order by qna_regDate desc) where rn between (#{current_page}-1)*#{list_count}+1 and #{current_page}*#{list_count}
		]]>
	</select>
	
	<!-- private int current_page; // 현재 페이지
	private int list_count; // 페이지당 결과수 [20,50]
	private String list_day; // 등록일 순 [[desc,asc]
	
	private Date startDate; //시작일
	private Date endDate; // 종료일
	private int status; // 답변상태[0:답변대기,1:답변완료]
	private String keyword_set; //검색조건[title,qna_writeId,product_name]
	private String keyword; // 검색어 -->
	
	<parameterMap type="com.spring.Uhdiya.board.qna.Qna_list" id="list" />
	<select id="test" resultMap="qna" parameterType="java.util.Map">
		select qna_id, product_name, qna_title, qna_content, qna_writeId, qna_regDate, qna_status, product_code 
		from (select rownum as rn, qna_id, product_name, qna_title, qna_content, qna_writeId, qna_regDate, qna_status, q.product_code 
		from qna q, product p where q.product_code = p.product_code
		
		<if test='startDate != null and endDate != null and startDate != "" and endDate != ""'>
			and qna_regDate between #{startDate, jdbcType=DATE} and #{endDate, jdbcType=DATE} 
		</if>
		
		<if test='keyword_set != "검색조건" and keyword != null and keyword_set == "qna_title"'>
			and qna_title like '%'||#{keyword}||'%'
		</if>
		<if test='keyword_set != "검색조건" and keyword != null and keyword_set == "qna_writeId"'>
			and qna_writeId like '%'||#{keyword}||'%'
		</if>
		<if test='keyword_set != "검색조건" and keyword != null and keyword_set == "product_name"'>
			and product_name like '%'||#{keyword}||'%'
		</if>
		 
		<if test="status != 2">
			and qna_status = #{status}
		</if>

		) where rn between #{startNum} and #{endNum} order by qna_regDate ${list_day} 
		
		<!-- 
		<choose>
			<when test="current_page == null or current_page == 1">
				) where rn between (1 - 1) * #{list_count} + 1 and 1 * #{list_count} 
			</when>
			<otherwise>
				) where rn between (#{current_page} - 1) * #{list_count} + 1 and #{current_page} * #{list_count}
			</otherwise>
		</choose>
		 -->
	</select>
	
	<select id="test2" resultMap="qna">
		<![CDATA[
			select qna_id, product_name, qna_title, qna_content, qna_writeId, qna_regDate, qna_status, product_code 
		from (select qna_id, product_name, qna_title, qna_content, qna_writeId, qna_regDate, qna_status, q.product_code 
		from qna q, product p where q.product_code = p.product_code and qna_parentId = 1)
		]]>
	</select>
</mapper>